/*
 * Test: try expression for early error propagation
 */
#include <ccc/std/prelude.cch>

/* Helper that may fail */
int!CCError maybe_parse(int x) {
    if (x < 0) {
        return cc_err(cc_error(CC_ERR_INVALID_ARG, "negative"));
    }
    return cc_ok(x * 2);
}

/* Function that uses try to propagate errors */
int!CCError compute(int a, int b) {
    int x = try maybe_parse(a);
    int y = try maybe_parse(b);
    return cc_ok(x + y);
}

int main(void) {
    /* Success case */
    int!CCError r1 = compute(5, 10);
    if (!r1.ok) {
        printf("FAIL: expected ok, got error\n");
        return 1;
    }
    if (r1.u.value != 30) {  /* (5*2) + (10*2) = 30 */
        printf("FAIL: expected 30, got %d\n", r1.u.value);
        return 1;
    }
    printf("SUCCESS: compute(5, 10) = %d\n", r1.u.value);
    
    /* Error case - first arg fails */
    int!CCError r2 = compute(-1, 10);
    if (r2.ok) {
        printf("FAIL: expected error, got ok\n");
        return 1;
    }
    printf("SUCCESS: compute(-1, 10) returned error: %s\n", r2.u.error.message);
    
    /* Error case - second arg fails */
    int!CCError r3 = compute(5, -2);
    if (r3.ok) {
        printf("FAIL: expected error, got ok\n");
        return 1;
    }
    printf("SUCCESS: compute(5, -2) returned error: %s\n", r3.u.error.message);
    
    printf("All try expression tests passed!\n");
    return 0;
}
