// Smoke test for spawn into syntax
#include <ccc/std/prelude.cch>
#include <stdio.h>

void* double_value(void* arg) {
    return (void*)((intptr_t)arg * 2);
}

int main() {
    CCTask[~4 >] tx;
    CCTask[~4 ordered <] rx;
    channel_pair(&tx, &rx);
    
    // Use spawn into to spawn task and send CCTask to channel
    @nursery closing(tx) {
        spawn into(tx) () => double_value((void*)21);
    }
    
    // Receive and verify
    void* result;
    int rc = ordered_recv(rx, &result);
    
    if (rc != 1) {
        printf("FAIL: expected rc=1, got %d\n", rc);
        return 1;
    }
    
    if ((intptr_t)result != 42) {
        printf("FAIL: expected 42, got %ld\n", (long)(intptr_t)result);
        return 1;
    }
    
    // Verify channel closed
    rc = ordered_recv(rx, &result);
    if (rc != 0) {
        printf("FAIL: expected rc=0 (closed), got %d\n", rc);
        return 1;
    }
    
    chan_free(rx);
    
    printf("spawn_into_smoke: PASS\n");
    return 0;
}
