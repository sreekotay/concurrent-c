#include "cc_runtime.cch"
#include "cc_channel.cch"
// This is a common foot-gun:
// `closing(ch)` closes the channel only after all nursery children exit.
// A consumer inside the same nursery that waits for "channel closed" can deadlock.
static volatile int received_sum = 0;
int main(void) {
    CCChanTx ch_tx;
    CCChanRx ch_rx;
    if (cc_chan_pair_create(1, CC_CHAN_MODE_BLOCK, false, sizeof(int), &ch_tx, &ch_rx) != 0) return 2;
    @nursery closing(ch_tx) {
        // Producer: finite sends.
        spawn(() => {
            for (int i = 1; i <= 3; i++) {
                (void)cc_chan_send(ch_tx.raw, &i, sizeof(i));
            }
        });
        // Consumer: recv-until-close INSIDE the same nursery => deadlock under spec semantics.
        spawn(() => {
            int v = 0;
            while (cc_chan_recv(ch_rx.raw, &v, sizeof(v)) == 0) {
                received_sum += v;
            }
        });
    }
    cc_chan_free(ch_tx.raw);
    return (received_sum == 6) ? 0 : 1;
}

