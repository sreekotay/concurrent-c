/*
 * Result channel smoke test: channels carrying T !> (E) types.
 */
#include <ccc/std/prelude.cch>
#include <stdio.h>
#include <assert.h>
#include <errno.h>

// Use built-in CCError for the error type
CCResult_int_CCError[~4 >] results_tx;
CCResult_int_CCError[~4 <] results_rx;
CCChan* g_ch;

int !> (CCError) make_ok_result(void) {
    return cc_ok(42);
}

int !> (CCError) make_err_result(void) {
    return cc_err(CC_ERR_PARSE, "bad input");
}

int main(void) {
    g_ch = channel_pair(&results_tx, &results_rx);
    
    // Send a success
    CCResult_int_CCError ok_result = make_ok_result();
    results_tx.send(ok_result);
    
    // Send an error
    CCResult_int_CCError err_result = make_err_result();
    results_tx.send(err_result);
    
    results_tx.close();
    
    // Receive
    CCResult_int_CCError r1 = {0};
    int e1 = results_rx.recv(&r1);
    assert(e1 == 0 && r1.ok && "first result should be ok");
    assert(r1.u.value == 42);
    
    CCResult_int_CCError r2 = {0};
    int e2 = results_rx.recv(&r2);
    assert(e2 == 0 && !r2.ok && "second result should be error");
    assert(r2.u.error.kind == CC_ERR_PARSE);
    
    cc_chan_free(g_ch);
    
    printf("result channel smoke: PASS\n");
    return 0;
}
