// Test: Closure can capture channel handles
#include <ccc/std/prelude.cch>
#include <assert.h>

int main(void) {
    int[~4 >] tx;
    int[~4 <] rx;
    CCChan* ch = channel_pair(&tx, &rx);
    
    // Capture channel handle in closure
    CCClosure0 producer = () => [tx] {
        for (int i = 0; i < 3; i++) {
            (void)chan_send(tx, i * 10);
        }
        chan_close(tx);
    };
    
    // Run the producer (invoke the closure)
    cc_run_blocking_closure0(producer);
    
    // Receive values
    int v;
    int sum = 0;
    while (cc_chan_recv(rx.raw, &v, sizeof(v)) == 0) {
        sum += v;
    }
    
    assert(sum == 0 + 10 + 20);  // 0 + 10 + 20 = 30
    
    cc_chan_free(ch);
    
    printf("closure_capture_channel_smoke: OK\n");
    return 0;
}
