// Smoke test for ordered channels with chan_send_task
// Verifies results arrive in submission order (FIFO)
#include <ccc/std/prelude.cch>
#include <stdio.h>

int compute(int x) {
    return x * 2;
}

int main() {
    CCTask[~8 >] tx;
    CCTask[~8 <] rx;
    channel_pair(&tx, &rx);
    
    int values[] = {10, 200, 30, 400, 50};
    int num_values = sizeof(values) / sizeof(values[0]);
    
    // Send tasks using chan_send_task (compiler lowers this)
    @nursery closing(tx) {
        for (int i = 0; i < num_values; i++) {
            int v = values[i];
            chan_send_task(tx, () => [v] compute(v));
        }
    }
    
    // Receive results in order
    void* result;
    int rc;
    int idx = 0;
    
    while ((rc = ordered_recv(rx, &result)) == 1 && idx < num_values) {
        int got = (int)(intptr_t)result;
        int expected = values[idx] * 2;
        if (got != expected) {
            printf("FAIL: position %d expected %d, got %d\n", idx, expected, got);
            chan_free(rx);
            return 1;
        }
        idx++;
    }
    
    if (idx != num_values) {
        printf("FAIL: expected %d values, got %d\n", num_values, idx);
        chan_free(rx);
        return 1;
    }
    
    chan_free(rx);
    printf("ordered_channel_smoke: PASS\n");
    return 0;
}
