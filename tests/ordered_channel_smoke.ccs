// Smoke test for ordered channels
#include <ccc/std/prelude.cch>
#include <stdio.h>

void* return_value(void* arg) {
    return arg;
}

int main() {
    // Test 1: Basic ordered channel type declaration
    CCTask[~4 >] tx;
    CCTask[~4 ordered <] rx;
    channel_pair(&tx, &rx);
    
    // Test 2: Send task and receive with ordered_recv
    CCTask task = cc_fiber_spawn_task(return_value, (void*)42);
    chan_send(tx, task);
    chan_close(tx);
    
    void* result;
    int rc = ordered_recv(rx, &result);
    
    if (rc != 1) {
        printf("FAIL: expected rc=1, got %d\n", rc);
        return 1;
    }
    
    if ((intptr_t)result != 42) {
        printf("FAIL: expected result=42, got %ld\n", (long)(intptr_t)result);
        return 1;
    }
    
    // Test 3: Verify channel closed returns 0
    rc = ordered_recv(rx, &result);
    if (rc != 0) {
        printf("FAIL: expected rc=0 (closed), got %d\n", rc);
        return 1;
    }
    
    chan_free(rx);
    
    printf("ordered_channel_smoke: PASS\n");
    return 0;
}
