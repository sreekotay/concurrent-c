#include "cc_runtime.cch"
#include "std/task_intptr.cch"

static int add1(int x) { return x + 1; } /* sync */

@async int tick(int x) {
    /* sync call -> auto-blocked */
    return add1(x);
}

@async int f(void) {
    int i = 0;
    int sum = 0;
    while (i < 3) {
        /* await in loop body via auto-blocking */
        sum = add1(sum);
        if (i == 1) {
            /* statement-form await (no recursion) */
            await tick(sum);
        } else {
            /* no-op */
            sum = sum;
        }
        i = i + 1;
    }
    return sum;
}

int main(void) {
    int r = cc_block_on(int, f());
    /* sum increments 3 times: 0->1->2->3 */
    return (r == 3) ? 0 : 1;
}

