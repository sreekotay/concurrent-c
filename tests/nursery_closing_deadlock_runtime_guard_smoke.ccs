#include "cc_runtime.cch"
#include "cc_channel.cch"

#include <stdlib.h>

static volatile int g_err = 0;

int main(void) {
    // Enable runtime guard: instead of deadlocking, cc_chan_recv returns EDEADLK in the foot-gun case.
    setenv("CC_NURSERY_CLOSING_RUNTIME_GUARD", "1", 1);

    // Buffer producer's sends so the producer can finish even if the consumer stops early.
    CCChanTx ch_tx;
    CCChanRx ch_rx;
    if (cc_chan_pair_create(3, CC_CHAN_MODE_BLOCK, false, sizeof(int), &ch_tx, &ch_rx) != 0) return 2;

    @nursery closing(ch_tx) {
        spawn(() => {
            for (int i = 1; i <= 3; i++) {
                int v = i;
                (void)cc_chan_send(ch_tx.raw, &v, sizeof(v));
            }
        });

        // This would deadlock without the runtime guard.
        spawn(() => {
            int v = 0;
            for (;;) {
                int rc = cc_chan_recv(ch_rx.raw, &v, sizeof(v));
                if (rc == 0) continue;
                g_err = rc; /* expect EDEADLK from the guard */
                break;
            }
        });
    }

    if (g_err != EDEADLK) return 10;
    cc_chan_free(ch_tx.raw);
    return 0;
}

