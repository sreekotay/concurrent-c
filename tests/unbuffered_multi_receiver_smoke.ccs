/*
 * Smoke test: Multiple receivers on unbuffered channel
 * 
 * This tests the rendezvous pattern with 1 sender + 2 receivers.
 * Symmetric to multi-sender test - verifies correct pairing.
 * 
 * Expected: All 20 messages sent and received, prints "PASS"
 */
#include <ccc/cc_runtime.cch>
#include <stdio.h>

int main(void) {
    int[~ >] tx;  /* Unbuffered */
    int[~ <] rx;
    channel_pair(&tx, &rx);

    @nursery closing(tx) {
        /* 1 sender, sends 20 messages */
        spawn([tx]() => {
            for (int i = 0; i < 20; i++) tx.send(i);
        });
        
        /* 2 receivers, each receives 10 messages */
        spawn([rx]() => {
            int v;
            for (int i = 0; i < 10; i++) rx.recv(&v);
        });
        spawn([rx]() => {
            int v;
            for (int i = 0; i < 10; i++) rx.recv(&v);
        });
    }

    printf("unbuffered_multi_receiver_smoke: PASS\n");
    return 0;
}
